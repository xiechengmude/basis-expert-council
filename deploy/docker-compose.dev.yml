# ==============================================================================
# BasisPilot (贝领) — Dev 服务器环境 (43.134.62.139)
# ==============================================================================
#
# Usage:
#   docker compose -f deploy/docker-compose.dev.yml --env-file .env.dev up -d --build
#
# 访问:
#   LangGraph API:    http://localhost:5095
#   Business API:     http://localhost:5096
#   Frontend:         http://localhost:8015
#   PostgreSQL:       localhost:5436
#   Redis:            localhost:6395
#
# ==============================================================================

name: basis-dev

services:
  # ============================================================================
  # PostgreSQL — LangGraph Checkpoint + 业务数据
  # ============================================================================
  basis-postgres:
    image: postgres:16-alpine
    container_name: basisPilot-postgres
    restart: unless-stopped
    ports:
      - "5436:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=langgraph
    volumes:
      - basis-postgres-data:/var/lib/postgresql/data
      - ../deploy/init.sql:/docker-entrypoint-initdb.d/20-business.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d langgraph"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - basis-network

  # ============================================================================
  # Redis — Streaming / Pub-Sub
  # ============================================================================
  basis-redis:
    image: redis:7-alpine
    container_name: basisPilot-redis
    restart: unless-stopped
    ports:
      - "6395:6395"
    volumes:
      - basis-redis-data:/data
    command: redis-server --port 6395 --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6395", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - basis-network

  # ============================================================================
  # Qdrant — Mem0 向量存储
  # ============================================================================
  basis-qdrant:
    image: qdrant/qdrant:v1.13.2
    container_name: basisPilot-qdrant
    restart: unless-stopped
    ports:
      - "6335:6333"
      - "6336:6334"
    volumes:
      - basis-qdrant-data:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/6333' || exit 1"]
      interval: 15s
      timeout: 5s
      start_period: 10s
      retries: 3
    networks:
      - basis-network

  # ============================================================================
  # LangGraph Agent — 官方镜像 (langgraph up 模式)
  # ============================================================================
  basis-agent:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: basisPilot-agent
    restart: unless-stopped
    ports:
      - "5095:5095"
    depends_on:
      basis-postgres:
        condition: service_healthy
      basis-redis:
        condition: service_healthy
      basis-qdrant:
        condition: service_healthy
    environment:
      # ---- Server ----
      - PORT=5095

      # ---- Graph 配置 ----
      - 'LANGSERVE_GRAPHS={"basis-expert": "/app/graph.py:agent"}'

      # ---- LangGraph License (必须) ----
      - LANGSMITH_API_KEY=${LANGSMITH_API_KEY}

      # ---- LangSmith Tracing ----
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-true}
      - LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT:-basis-expert-dev}

      # ---- Database ----
      - DATABASE_URI=postgresql://postgres:postgres@basis-postgres:5432/langgraph?sslmode=disable
      - REDIS_URI=redis://basis-redis:6395

      # ---- 迁移控制 ----
      - RUN_MIGRATIONS=${RUN_MIGRATIONS:-true}

      # ---- LLM 配置 (从 .env.dev 透传) ----
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}

      # ---- BASIS 模型配置 ----
      - BASIS_LEAD_MODEL=${BASIS_LEAD_MODEL:-openai:z-ai/glm-5}
      - BASIS_SUBAGENT_MODEL=${BASIS_SUBAGENT_MODEL:-openai:minimax/minimax-m2.5}
      - BASIS_MATH_MODEL=${BASIS_MATH_MODEL:-}
      - BASIS_SCIENCE_MODEL=${BASIS_SCIENCE_MODEL:-}
      - BASIS_HUMANITIES_MODEL=${BASIS_HUMANITIES_MODEL:-}
      - BASIS_CURRICULUM_MODEL=${BASIS_CURRICULUM_MODEL:-}
      - BASIS_BUSINESS_MODEL=${BASIS_BUSINESS_MODEL:-}

      # ---- Mem0 记忆系统 ----
      - MEM0_QDRANT_HOST=basis-qdrant
      - MEM0_QDRANT_PORT=6333
      - MEM0_QDRANT_COLLECTION=basispilot_memories
      - MEM0_LLM_MODEL=${MEM0_LLM_MODEL:-Pro/deepseek-ai/DeepSeek-V3.2}
      - MEM0_EMBEDDING_MODEL=${MEM0_EMBEDDING_MODEL:-Qwen/Qwen3-Embedding-4B}
      - MEM0_EMBEDDING_DIMS=${MEM0_EMBEDDING_DIMS:-2560}
      - EMBEDDING_API_KEY=${EMBEDDING_API_KEY:-${OPENAI_API_KEY}}
      - EMBEDDING_BASE_URL=${EMBEDDING_BASE_URL:-${OPENAI_BASE_URL}}

      # ---- Langfuse Tracing ----
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-}
      - LANGFUSE_ENABLED=${LANGFUSE_ENABLED:-false}

      # ---- OTEL Tracing ----
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-}
      - OTEL_EXPORTER_OTLP_PROTOCOL=${OTEL_EXPORTER_OTLP_PROTOCOL:-}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-basis-expert-dev}
      - OTEL_EXPORTER_OTLP_HEADERS=${OTEL_EXPORTER_OTLP_HEADERS:-}

      # ---- 功能开关 ----
      - AGENT_RECURSION_LIMIT=${AGENT_RECURSION_LIMIT:-200}
      - LANGGRAPH_DEFAULT_RECURSION_LIMIT=${LANGGRAPH_DEFAULT_RECURSION_LIMIT:-200}
      - LANGGRAPH_SKIP_BLOCKING_CHECK=${LANGGRAPH_SKIP_BLOCKING_CHECK:-true}

      # ---- 禁用代理 ----
      - NO_PROXY=localhost,127.0.0.1,basis-postgres,basis-redis,basis-qdrant
      - HTTP_PROXY=
      - HTTPS_PROXY=

    volumes:
      - ../.env.dev:/app/.env:ro

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5095/ok"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 3

    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"

    networks:
      - basis-network

  # ============================================================================
  # Business API — 认证/用户/配额/定价
  # ============================================================================
  basis-api:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.api
    container_name: basisPilot-api
    restart: unless-stopped
    ports:
      - "5096:5096"
    depends_on:
      basis-postgres:
        condition: service_healthy
    environment:
      - BASIS_API_PORT=5096
      - BASIS_DATABASE_URL=postgresql://postgres:postgres@basis-postgres:5432/langgraph?sslmode=disable
      - BASIS_JWT_SECRET=${BASIS_JWT_SECRET}
      - WECHAT_APP_ID=${WECHAT_APP_ID:-}
      - WECHAT_APP_SECRET=${WECHAT_APP_SECRET:-}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET:-}
      - LANGGRAPH_URL=http://basis-agent:5095
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:8015}

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5096/ok"]
      interval: 15s
      timeout: 5s
      start_period: 15s
      retries: 3

    networks:
      - basis-network

  # ============================================================================
  # Frontend — Next.js 生产服务
  # ============================================================================
  basis-frontend:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.frontend
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${STORE_SUPABASE_URL:-}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${STORE_SUPABASE_ANON_KEY:-}
        NEXT_PUBLIC_BASIS_API_URL: ${NEXT_PUBLIC_BASIS_API_URL:-http://basis-api:5096}
        NEXT_PUBLIC_LANGGRAPH_URL: ${NEXT_PUBLIC_LANGGRAPH_URL:-http://basis-agent:5095}
    container_name: basisPilot-frontend
    restart: unless-stopped
    ports:
      - "8015:8015"
    depends_on:
      basis-agent:
        condition: service_healthy
    environment:
      - PORT=8015
      - HOSTNAME=0.0.0.0

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8015"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

    networks:
      - basis-network

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  basis-postgres-data:
  basis-redis-data:
  basis-qdrant-data:

# ==============================================================================
# Networks
# ==============================================================================
networks:
  basis-network:
    name: basis-network
