# ==============================================================================
# BasisPilot (贝领) — Frontend (Next.js Standalone)
# ==============================================================================
# 多阶段构建: builder → runner
# 使用 standalone output 模式，最小化镜像体积
# ==============================================================================

# ---- Stage 1: Builder ----
FROM node:22-alpine AS builder

WORKDIR /app

# Build-time env vars required by Next.js static generation
ARG NEXT_PUBLIC_SUPABASE_URL
ARG NEXT_PUBLIC_SUPABASE_ANON_KEY
ARG NEXT_PUBLIC_BASIS_API_URL
ARG NEXT_PUBLIC_LANGGRAPH_URL
ENV NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL
ENV NEXT_PUBLIC_SUPABASE_ANON_KEY=$NEXT_PUBLIC_SUPABASE_ANON_KEY
ENV NEXT_PUBLIC_BASIS_API_URL=$NEXT_PUBLIC_BASIS_API_URL
ENV NEXT_PUBLIC_LANGGRAPH_URL=$NEXT_PUBLIC_LANGGRAPH_URL

# Install dependencies
COPY frontend/package.json frontend/yarn.lock* ./
RUN yarn install --frozen-lockfile

# Copy source code
COPY frontend/ ./

# Build (使用 webpack，避免 Turbopack 路由冲突)
RUN npx next build --webpack

# ---- Stage 2: Runner ----
FROM node:22-alpine AS runner

WORKDIR /app

ENV NODE_ENV=production
ENV PORT=8015

RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# Copy standalone build output
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 8015

CMD ["node", "server.js"]
