# BasisPilot 真题库系统 — 使用指南

> 版本: v1.0
> 更新日期: 2026-02-21
> 前置条件: 测评系统 MVP 已跑通, PostgreSQL 数据库已初始化

---

## 1. 系统概述

真题库系统是测评引擎的数据层，负责题目的导入、管理、校验、导出和审核。所有数据持久化到 PostgreSQL `assessment_questions` 表。

```
┌──────────────────────────────────────────────────────┐
│                   真题库系统架构                        │
│                                                      │
│  数据来源                管理层              消费方      │
│  ────────              ──────              ──────     │
│  JSON 文件  ──┐                                       │
│  CSV/Excel ──┼──▶  导入管道  ──▶  PostgreSQL  ──▶ CAT │
│  Admin API ──┘    (校验+批次)    assessment_    引擎   │
│                                 questions            │
│                                     │                │
│                    Admin API ◀──────┘                 │
│                    (CRUD/审核/统计)                     │
│                                     │                │
│                    CLI 工具 ◀────────┘                 │
│                    (导入/导出/统计)                     │
└──────────────────────────────────────────────────────┘
```

### 与 CAT 引擎的关系

CAT 引擎通过 `db.find_next_question()` 选题。新导入的题目自动进入出题池，**零代码改动**。出题时自动过滤 `review_status`，仅 `approved`、`draft`、`NULL` 状态的题目会被选中，`archived` 状态的题目被排除。

---

## 2. 数据模型

### 2.1 题目表 `assessment_questions`

| 字段 | 类型 | 说明 | 必填 |
|------|------|------|------|
| `id` | SERIAL PK | 自增主键 | 自动 |
| `subject` | TEXT | 学科: math/english/science/chinese/physics/chemistry/biology/history | Y |
| `grade_level` | TEXT | 年级: G1-G12 | Y |
| `topic` | TEXT | 知识点: algebra, geometry_intro, reading_comp... | Y |
| `subtopic` | TEXT | 子知识点 | N |
| `difficulty` | REAL | 难度 0.0-1.0 | Y (默认 0.5) |
| `question_type` | TEXT | 题型: mcq/fill_in/short_answer/essay/experiment | Y |
| `content_zh` | JSONB | 中文内容 `{stem, options?, answer?, rubric?}` | Y |
| `content_en` | JSONB | 英文内容 (同结构) | N (默认复用 zh) |
| `basis_aligned` | BOOLEAN | 是否对齐 BASIS 课程 | N (默认 true) |
| `tags` | TEXT[] | 标签数组 | N |
| `source` | TEXT | 来源: basis_exam/ap_exam/sat/custom/seed | N |
| `source_year` | INT | 出处年份 | N |
| `source_detail` | TEXT | 详细出处说明 | N |
| `curriculum_code` | TEXT | 课标编码: CCSS.MATH.7.EE.4 | N |
| `discrimination` | REAL | IRT 区分度 0-1 | N |
| `review_status` | TEXT | 审核状态: draft/reviewed/approved/archived | N (默认 draft) |
| `reviewed_by` | TEXT | 审核人 | N |
| `version` | INT | 版本号 | N (默认 1) |
| `explanation_zh` | TEXT | 中文解析 | N |
| `explanation_en` | TEXT | 英文解析 | N |
| `image_urls` | TEXT[] | 图片 URL 数组 | N |
| `metadata` | JSONB | 扩展元数据 | N (默认 {}) |
| `batch_id` | INT | 关联导入批次 | N |
| `usage_count` | INT | 使用次数 (引擎自动更新) | 自动 |
| `correct_rate` | REAL | 历史正确率 (引擎自动更新) | 自动 |
| `created_at` | TIMESTAMPTZ | 创建时间 | 自动 |
| `updated_at` | TIMESTAMPTZ | 更新时间 | 自动 |

### 2.2 MCQ 题目的 `content_zh` 结构

```json
{
  "stem": "解方程：2(x + 3) = 14",
  "options": ["A. x = 2", "B. x = 4", "C. x = 5", "D. x = 7"],
  "answer": "B"
}
```

### 2.3 导入批次表 `question_import_batches`

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | SERIAL PK | 批次 ID |
| `batch_name` | TEXT | 批次名称 |
| `source` | TEXT | 来源 |
| `imported_by` | TEXT | 导入人 |
| `question_count` | INT | 题目数量 |
| `status` | TEXT | pending/imported/validated/failed |
| `error_log` | TEXT | 错误日志 |
| `created_at` | TIMESTAMPTZ | 创建时间 |

---

## 3. 导入指南

### 3.1 JSON 文件导入 (推荐)

这是主力导入方式。每个 JSON 文件代表一套试卷或一组题目。

**文件格式:**

```json
{
  "batch_name": "BASIS 深圳 2024 G7 数学期中考",
  "source": "basis_exam",
  "source_year": 2024,
  "subject": "math",
  "grade_level": "G7",
  "questions": [
    {
      "topic": "linear_equations",
      "subtopic": "two_step",
      "difficulty": 0.55,
      "question_type": "mcq",
      "content_zh": {
        "stem": "解方程：2(x + 3) = 14",
        "options": ["A. x = 2", "B. x = 4", "C. x = 5", "D. x = 7"],
        "answer": "B"
      },
      "content_en": {
        "stem": "Solve: 2(x + 3) = 14",
        "options": ["A. x = 2", "B. x = 4", "C. x = 5", "D. x = 7"],
        "answer": "B"
      },
      "explanation_zh": "2(x+3)=14 → x+3=7 → x=4",
      "explanation_en": "2(x+3)=14 → x+3=7 → x=4",
      "curriculum_code": "CCSS.MATH.7.EE.4",
      "tags": ["linear_equations", "distributive"]
    }
  ]
}
```

**字段说明:**

- 顶层 `subject`, `grade_level`, `source`, `source_year` 会作为默认值注入每个题目（题目级别的值优先）
- `questions` 数组中每个题目的 `content_zh` 为必填
- `content_en` 可选，如不提供则自动复用 `content_zh`
- 模板文件: `data/templates/question_template.json`

**导入命令:**

```bash
# 导入单个文件
python -m src.basis_expert_council.question_bank import data/question_banks/math/G7/midterm_2024.json

# 指定导入人
python -m src.basis_expert_council.question_bank import data/question_banks/math/G7/midterm_2024.json --by "张老师"

# 跳过校验 (不推荐)
python -m src.basis_expert_council.question_bank import data/question_banks/math/G7/midterm_2024.json --no-validate
```

### 3.2 CSV/Excel 导入 (教师友好)

适合教师使用 Excel 录入题目后批量导入。

**列名规范:**

| 列名 | 必填 | 说明 |
|------|------|------|
| `stem_zh` | Y | 中文题干 |
| `stem_en` | N | 英文题干 |
| `option_a` | Y (MCQ) | 选项 A 文字 |
| `option_b` | Y (MCQ) | 选项 B 文字 |
| `option_c` | N | 选项 C 文字 |
| `option_d` | N | 选项 D 文字 |
| `answer` | Y | 正确答案 (A/B/C/D) |
| `topic` | Y | 知识点 |
| `subtopic` | N | 子知识点 |
| `difficulty` | N | 难度 0-1 (默认 0.5) |
| `grade_level` | N | 年级 (默认 G7) |
| `subject` | N | 学科 (默认 math) |
| `question_type` | N | 题型 (默认 mcq) |
| `explanation` | N | 中文解析 |
| `explanation_en` | N | 英文解析 |

**模板文件:** `data/templates/question_template.csv`

**导入命令:**

```bash
# CSV 文件
python -m src.basis_expert_council.question_bank import-csv data/question_banks/math/G7/teacher_input.csv

# Excel 文件 (需要 openpyxl: pip install openpyxl)
python -m src.basis_expert_council.question_bank import-csv data/question_banks/math/G7/teacher_input.xlsx
```

### 3.3 目录批量导入

递归扫描目录下所有 `.json` 文件并逐个导入。

```bash
# 导入 math 目录下所有 JSON
python -m src.basis_expert_council.question_bank import-dir data/question_banks/math/

# 导入全部题库
python -m src.basis_expert_council.question_bank import-dir data/question_banks/
```

### 3.4 Admin API 在线导入

```bash
curl -X POST http://localhost:5096/api/admin/questions/import \
  -H "Content-Type: application/json" \
  -H "X-Admin-Secret: YOUR_SECRET" \
  -d '{
    "batch_name": "API 导入测试",
    "source": "custom",
    "subject": "math",
    "grade_level": "G7",
    "questions": [
      {
        "topic": "algebra",
        "content_zh": {"stem": "计算 3x + 5 = 20 中 x 的值", "options": ["A. 3", "B. 5", "C. 7", "D. 15"], "answer": "B"},
        "difficulty": 0.45,
        "tags": ["algebra", "one_step"]
      }
    ]
  }'
```

---

## 4. 校验规则

每道题导入前必须通过以下校验:

| 规则 | 说明 |
|------|------|
| 必填字段 | subject, grade_level, topic, question_type, content_zh |
| 学科合法 | math, english, science, chinese, physics, chemistry, biology, history |
| 年级合法 | G1 - G12 |
| 题型合法 | mcq, fill_in, short_answer, essay, experiment |
| 难度范围 | 0.05 - 0.95 (超出为警告) |
| 题干长度 | content_zh.stem >= 5 字符 |
| MCQ 选项数 | 3-5 个选项 |
| MCQ 答案 | answer 必须存在 |
| MCQ 去重 | 选项不能重复 |
| fill_in 答案 | answer 必须存在 |

**仅校验不导入:**

```bash
python -m src.basis_expert_council.question_bank validate data/templates/question_template.json
```

---

## 5. 审核流程

题目生命周期: `draft` → `reviewed` → `approved` → (可选) `archived`

| 状态 | 说明 | CAT 出题 |
|------|------|---------|
| `draft` | 新导入/新建 | 可出题 |
| `reviewed` | 已人工审核 | 可出题 |
| `approved` | 正式审批通过 | 可出题 |
| `archived` | 已归档/停用 | 不出题 |

### CLI 审核 (通过 Admin API)

```bash
# 审核通过
curl -X POST http://localhost:5096/api/admin/questions/42/review \
  -H "Content-Type: application/json" \
  -H "X-Admin-Secret: YOUR_SECRET" \
  -d '{"status": "approved", "reviewed_by": "张老师"}'

# 归档题目
curl -X POST http://localhost:5096/api/admin/questions/42/review \
  -H "Content-Type: application/json" \
  -H "X-Admin-Secret: YOUR_SECRET" \
  -d '{"status": "archived", "reviewed_by": "admin"}'
```

---

## 6. Admin API 完整参考

> 鉴权方式: 请求头 `X-Admin-Secret: <BASIS_ADMIN_SECRET 环境变量>` 或已登录 teacher 角色用户

### 6.1 题目 CRUD

| 方法 | 路径 | 说明 |
|------|------|------|
| `POST` | `/api/admin/questions` | 创建单题 |
| `PUT` | `/api/admin/questions/{id}` | 编辑题目 |
| `DELETE` | `/api/admin/questions/{id}` | 归档题目 (加 `?hard=true` 物理删除) |
| `GET` | `/api/admin/questions` | 分页查询 |
| `GET` | `/api/admin/questions/stats` | 题库统计 |
| `POST` | `/api/admin/questions/{id}/review` | 审核题目 |
| `POST` | `/api/admin/questions/import` | 批量导入 |
| `GET` | `/api/admin/import-batches` | 导入批次列表 |

### 6.2 查询参数 (`GET /api/admin/questions`)

| 参数 | 说明 | 示例 |
|------|------|------|
| `subject` | 按学科筛选 | `?subject=math` |
| `grade_level` | 按年级筛选 | `?grade_level=G7` |
| `topic` | 按知识点筛选 | `?topic=algebra` |
| `review_status` | 按审核状态筛选 | `?review_status=approved` |
| `source` | 按来源筛选 | `?source=basis_exam` |
| `question_type` | 按题型筛选 | `?question_type=mcq` |
| `search` | 全文搜索 (题干内容) | `?search=方程` |
| `page` | 页码 (默认 1) | `?page=2` |
| `page_size` | 每页数量 (默认 20) | `?page_size=50` |

**响应格式:**

```json
{
  "items": [...],
  "total": 156,
  "page": 1,
  "page_size": 20,
  "total_pages": 8
}
```

### 6.3 统计响应 (`GET /api/admin/questions/stats`)

```json
{
  "total": 156,
  "by_subject": {"math": 100, "english": 56},
  "by_grade": {"G5": 25, "G6": 25, "G7": 56, "G8": 50},
  "by_review_status": {"draft": 100, "approved": 56},
  "by_question_type": {"mcq": 156},
  "by_source": {"seed": 100, "basis_exam": 56},
  "difficulty": {"avg": 0.503, "min": 0.150, "max": 0.900}
}
```

---

## 7. CLI 命令速查

```bash
# ─── 导入 ───────────────────────────────────────
# JSON 文件
python -m src.basis_expert_council.question_bank import <path.json>
python -m src.basis_expert_council.question_bank import <path.json> --by "张老师"

# CSV/Excel
python -m src.basis_expert_council.question_bank import-csv <path.csv|xlsx>

# 递归导入目录
python -m src.basis_expert_council.question_bank import-dir <dir>

# ─── 校验 ───────────────────────────────────────
python -m src.basis_expert_council.question_bank validate <path.json>

# ─── 统计 ───────────────────────────────────────
python -m src.basis_expert_council.question_bank stats

# ─── 导出 ───────────────────────────────────────
# JSON 格式
python -m src.basis_expert_council.question_bank export --subject math --grade G7 -o output.json

# CSV 格式 (给教师审核)
python -m src.basis_expert_council.question_bank export-csv --subject math --grade G7 -o output.csv
```

---

## 8. 文件目录结构

```
src/basis_expert_council/
  question_bank/
    __init__.py            # 模块入口
    __main__.py            # python -m 支持
    cli.py                 # CLI 命令解析与执行
    validator.py           # 题目格式校验器
    importer.py            # JSON / CSV / Excel 导入器
    exporter.py            # JSON / CSV 导出器
    stats.py               # 题库统计报告

data/
  question_banks/           # 真题 JSON 文件存放目录
    math/
      G5/                   # G5 数学真题
      G6/
      G7/
      G8/
    english/                # 英语真题
    science/                # 科学真题
  templates/
    question_template.json  # JSON 导入模板 (含 2 道示例题)
    question_template.csv   # CSV 导入模板
```

---

## 9. 环境变量

| 变量 | 说明 | 默认值 |
|------|------|--------|
| `BASIS_DATABASE_URL` | PostgreSQL 连接串 | `postgresql://postgres:postgres@localhost:5433/langgraph` |
| `BASIS_ADMIN_SECRET` | Admin API 鉴权密钥 | (空 = 仅 teacher 角色可用) |

---

## 10. 典型工作流

### 10.1 教师录入新真题

```
1. 复制 data/templates/question_template.csv
2. 在 Excel 中按列名填入题目
3. 运行: python -m src.basis_expert_council.question_bank import-csv 试卷.xlsx
4. 通过 Admin API 审核: POST /api/admin/questions/{id}/review {"status":"approved"}
5. 题目自动进入 CAT 出题池
```

### 10.2 批量导入历年真题

```
1. 准备 JSON 文件，按 data/templates/question_template.json 格式
2. 放入 data/question_banks/math/G7/ 目录
3. 运行: python -m src.basis_expert_council.question_bank import-dir data/question_banks/math/G7/
4. 查看统计: python -m src.basis_expert_council.question_bank stats
```

### 10.3 题库备份与恢复

```
# 备份: 导出为 JSON
python -m src.basis_expert_council.question_bank export -o backup.json

# 恢复: 从 JSON 导入
python -m src.basis_expert_council.question_bank import backup.json
```

### 10.4 质量审核流程

```
# 1. 导出 CSV 给教师审核
python -m src.basis_expert_council.question_bank export-csv --subject math --grade G7 -o review.csv

# 2. 教师在 Excel 中标注问题

# 3. 通过 Admin API 批量审核
curl -X POST http://localhost:5096/api/admin/questions/42/review \
  -H "X-Admin-Secret: $SECRET" \
  -d '{"status":"approved","reviewed_by":"张老师"}'
```

---

## 11. 注意事项

1. **Schema 迁移**: 所有 `ALTER TABLE` 使用 `IF NOT EXISTS`，服务启动时自动执行，无需手动迁移
2. **导入幂等性**: 每次导入创建新记录，不会覆盖已有题目。重复导入会产生重复题目
3. **难度标定**: 初始难度由导入时指定，引擎会根据实际答题数据自动更新 `correct_rate`
4. **种子题兼容**: 原有 100 道种子题的 `review_status` 为 `draft`/`NULL`，不影响出题
5. **删除安全**: 默认删除为归档 (`archived`)，不会物理删除。需要物理删除请加 `?hard=true`
6. **Excel 依赖**: 导入 `.xlsx` 文件需要额外安装 `openpyxl`: `pip install openpyxl`
