# BasisPilot 测评系统 — 完整架构体系

> 版本: v1.0 (Phase 1 MVP)
> 更新日期: 2026-02-21
> 状态: 全流程已跑通 (Docker E2E 验证通过)

---

## 1. 系统定位

**免费测评 → 报告 → 转化** 漏斗的核心引擎。

用户无需注册即可完成学科测评，获得专业诊断报告后自然引导付费转化。

| 维度 | 当前 MVP | 目标 |
|------|---------|------|
| 学科 | 数学 (Math) | 数学、英语、科学 |
| 年级 | G5-G8 | G1-G12 |
| 题型 | MCQ (单选) | MCQ + 填空 + 主观题 |
| 题量 | 100 道 (每年级 25) | 500+ 真题题库 |
| 语言 | 中英双语 | 中/英/繁体 |

---

## 2. 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端 (Next.js 16)                      │
│                                                              │
│  /assessment          测评落地页 (营销入口)                      │
│  /assessment/start    3步向导 (年级→学科→目标)                   │
│  /assessment/[id]/take  答题页 (CAT 自适应)                     │
│  /assessment/[id]/report  报告页 (6大可视化模块)                  │
│  /assessment/shared/[token]  分享链接 (公开报告)                 │
│                                                              │
└──────────────────────────┬──────────────────────────────────┘
                           │ HTTP API
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   Business API (FastAPI :5096)                 │
│                                                              │
│  POST /api/assessment/start          创建 session + 出第一题    │
│  POST /api/assessment/{id}/answer    提交答案 + 获取下一题       │
│  POST /api/assessment/{id}/complete  结束 session + 生成报告    │
│  GET  /api/assessment/{id}/status    获取 session 状态          │
│  GET  /api/assessment/{id}/resume    恢复中断 session           │
│  GET  /api/assessment/report/{id}    获取完整报告 (需登录)       │
│  GET  /api/assessment/report/{id}/status  轮询报告状态          │
│  POST /api/assessment/report/{id}/share   生成分享链接          │
│  GET  /api/assessment/shared/{token}      公开报告              │
│  POST /api/assessment/claim          登录后认领匿名 session     │
│  GET  /api/assessment/history        用户历史测评              │
│  GET  /api/assessment/types          可用测评类型              │
│                                                              │
│  ┌────────────────────┐  ┌────────────────────────────────┐  │
│  │  CAT 自适应引擎     │  │  报告生成器 (规则 + Agent)       │  │
│  │  assessment_engine  │  │  assessment/report.py          │  │
│  └────────────────────┘  └────────────────────────────────┘  │
│                                                              │
└──────────────────────────┬──────────────────────────────────┘
                           │ SQL
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              PostgreSQL 16 (langgraph DB)                     │
│                                                              │
│  assessment_questions  — 题库 (100 道, 中英双语)                │
│  assessment_sessions   — 测评 session                         │
│  assessment_answers    — 每题作答记录                           │
│  assessment_reports    — 生成的报告                            │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 数据库 Schema

### 3.1 assessment_questions (题库)

```sql
CREATE TABLE assessment_questions (
    id              SERIAL PRIMARY KEY,
    subject         TEXT NOT NULL,           -- 'math', 'english', 'science'
    grade_level     TEXT NOT NULL,           -- 'G5', 'G6', 'G7', 'G8'
    topic           TEXT NOT NULL,           -- 知识点大类
    subtopic        TEXT,                    -- 知识点细类
    difficulty      REAL NOT NULL DEFAULT 0.5, -- 0.0-1.0 难度系数
    question_type   TEXT NOT NULL,           -- 'mcq', 'fill_in'
    content_zh      JSONB NOT NULL,          -- 中文题目 {stem, options?, answer, explanation?}
    content_en      JSONB NOT NULL,          -- 英文题目 {stem, options?, answer, explanation?}
    basis_aligned   BOOLEAN DEFAULT TRUE,    -- 是否对齐 BASIS 课标
    usage_count     INT DEFAULT 0,           -- 使用次数
    correct_rate    REAL,                    -- 历史正确率
    avg_time_sec    INT,                     -- 平均用时
    tags            TEXT[],                  -- 标签数组
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);
```

**当前题库分布 (100 道):**

| 年级 | 知识点覆盖 | 难度范围 | 题量 |
|------|-----------|---------|------|
| G5 | integers, fractions, decimals, ratios, expressions, geometry, word_problems, data_analysis | 0.30-0.60 | 25 |
| G6 | linear_equations, inequalities, linear_functions, systems, exponents, polynomials, radicals, quadratics, word_problems, data_analysis, coordinate_geometry, ratios | 0.35-0.75 | 25 |
| G7 | angles, triangles, parallel_lines, circles, area, volume, surface_area, similarity, coordinate_geometry, transformations, proofs, data_analysis, word_problems | 0.30-0.75 | 25 |
| G8 | quadratics, functions, exponential, logarithms, polynomials, trigonometry, sequences, complex_numbers, rational_expressions, conic_sections, systems, word_problems | 0.45-0.80 | 25 |

### 3.2 assessment_sessions

```sql
CREATE TABLE assessment_sessions (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id             INT REFERENCES biz_users(id),  -- NULL = 匿名
    anonymous_id        TEXT,                           -- localStorage UUID
    subject             TEXT NOT NULL,
    grade_level         TEXT NOT NULL,
    assessment_type     TEXT NOT NULL,        -- 'quick'|'subject_diagnostic'|'pre_admission'
    status              TEXT NOT NULL DEFAULT 'in_progress',
    current_difficulty  REAL NOT NULL DEFAULT 0.5,
    total_questions     INT DEFAULT 0,
    correct_count       INT DEFAULT 0,
    total_time_sec      INT DEFAULT 0,
    final_score         REAL,
    ability_level       REAL,
    started_at          TIMESTAMPTZ DEFAULT NOW(),
    completed_at        TIMESTAMPTZ
);
```

### 3.3 assessment_answers

```sql
CREATE TABLE assessment_answers (
    id              SERIAL PRIMARY KEY,
    session_id      UUID NOT NULL REFERENCES assessment_sessions(id),
    question_id     INT NOT NULL REFERENCES assessment_questions(id),
    question_order  INT NOT NULL,
    user_answer     TEXT,
    is_correct      BOOLEAN,
    score           REAL DEFAULT 0,
    difficulty_at   REAL,                    -- 答题时的难度水平
    time_spent_sec  INT,
    answered_at     TIMESTAMPTZ DEFAULT NOW()
);
```

### 3.4 assessment_reports

```sql
CREATE TABLE assessment_reports (
    id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id   UUID UNIQUE NOT NULL REFERENCES assessment_sessions(id),
    user_id      INT REFERENCES biz_users(id),
    report_data  JSONB NOT NULL DEFAULT '{}',  -- 规则计算的统计数据
    share_token  TEXT UNIQUE,
    created_at   TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 4. CAT 自适应测评引擎

### 4.1 核心算法 (`assessment_engine.py`)

```
初始难度: 0.5

每答一题:
├── 答对 → 难度 += 0.15 (连续答对 ≥2 → += 0.25)
├── 答错 → 难度 -= 0.15 (连续答错 ≥2 → -= 0.25)
└── 难度限制在 [0.05, 0.95]

终止条件 (按优先级):
1. 达到最大题数 (quick=8, diagnostic=15, pre_admission=20)
2. 题库耗尽 (所有可用题已回答)

能力估算:
ability_level = 最后 5 次答题难度的加权平均 (近期权重更高)
```

### 4.2 出题策略 — 5 级 Fallback (`db.find_next_question`)

```
Level 1: 目标年级 + 目标难度 ±0.15
         │ 找不到 ↓
Level 2: 目标年级 + 扩大难度 ±0.35
         │ 找不到 ↓
Level 3: 目标年级 + 无难度限制
         │ 找不到 ↓
Level 4: 相邻年级 (±1级) + 按难度距离排序
         │ 找不到 ↓
Level 5: 同学科全题库 + 按难度距离排序
```

这确保即使某年级题目用完，测评也不会中断。

### 4.3 CATState 数据结构

```python
@dataclass
class CATState:
    subject: str
    grade_level: str
    assessment_type: str
    current_difficulty: float = 0.5
    question_count: int = 0
    correct_count: int = 0
    consecutive_correct: int = 0
    consecutive_wrong: int = 0
    difficulty_history: list[float]
    answered_question_ids: list[int]
```

状态通过 `assessment_sessions` 表 + `assessment_answers` 表完全持久化，支持断点续做。

---

## 5. 测评类型

| 类型 | 题数 | 时长 | 用途 |
|------|------|------|------|
| `quick` | 8 题 | ~10 分钟 | 快速摸底，低门槛入口 |
| `subject_diagnostic` | 15 题 | ~20 分钟 | 单科深度诊断 |
| `pre_admission` | 20 题 | ~25 分钟 | 入学能力全面评估 |

每种类型的 subjects 和 grade_levels 在 `ASSESSMENT_TYPES` 常量中定义。

---

## 6. 报告生成

### 6.1 两阶段生成

```
Phase 1 (即时): 规则计算
├── accuracy:         总正确率
├── score:            0-100 分数
├── ability_level:    0.0-1.0 能力估值
├── grade_equivalent: 年级等效描述
├── topic_scores:     各知识点正确率
├── weak_topics:      薄弱知识点
├── strong_topics:    强项知识点
├── difficulty_progression: 难度曲线
└── recommendations:  学习建议

Phase 2 (异步): AI Agent 分析 (可选)
├── 调用 LangGraph Agent (如可用)
├── 生成个性化分析文本
├── 写入 report_data.agent_analysis
└── Fallback: 模板文本生成
```

### 6.2 Report Data 示例

```json
{
  "score": 47.0,
  "accuracy": 0.28,
  "ability_level": 0.47,
  "grade_equivalent": "Approaching G7, near G6 level",
  "total_questions": 25,
  "correct_count": 7,
  "topic_scores": {
    "angles": {"correct": 1, "total": 2, "accuracy": 0.5},
    "triangles": {"correct": 2, "total": 4, "accuracy": 0.5},
    "circles": {"correct": 0, "total": 2, "accuracy": 0.0}
  },
  "weak_topics": ["circles", "parallel_lines"],
  "strong_topics": ["triangles"],
  "difficulty_progression": [0.5, 0.35, 0.2, 0.35, ...],
  "recommendations": [
    {"topic": "circles", "suggestion": "..."},
    {"topic": "parallel_lines", "suggestion": "..."}
  ]
}
```

---

## 7. 匿名 → 注册转化流程

```
1. 用户访问 /assessment，无需登录
2. 前端生成 anonymous_id (localStorage UUID)
3. 所有 API 调用携带 anonymous_id
4. 答题完成 → 弹出登录弹窗
5. 用户注册/登录
6. 前端调用 POST /api/assessment/claim {anonymous_id}
7. 后端将该 anonymous_id 的所有 session 关联到 user_id
8. 跳转报告页 (已认证，可查看完整报告)
```

---

## 8. 前端页面结构

```
frontend/src/app/assessment/
├── page.tsx                         营销落地页
├── components/
│   ├── AssessmentHero.tsx           Hero 区域 (3种测评卡片)
│   ├── AssessmentTypes.tsx          测评类型详情
│   ├── TrustSection.tsx             信任背书
│   ├── AssessmentFooter.tsx         CTA 底部
│   ├── AssessmentNav.tsx            导航栏
│   └── RadarChart.tsx               纯 SVG 雷达图
│
├── start/
│   ├── page.tsx                     3步向导入口
│   ├── AssessmentWizard.tsx         向导组件
│   └── components/
│       ├── GradeSelector.tsx        Step 1: 选择年级
│       ├── SubjectSelector.tsx      Step 2: 选择学科
│       └── GoalSelector.tsx         Step 3: 选择目标
│
├── [id]/take/
│   ├── page.tsx                     答题页入口
│   └── components/
│       ├── QuizHeader.tsx           进度条 + 计时器
│       ├── QuestionCard.tsx         题目展示 (KaTeX 数学公式)
│       ├── MCQOptions.tsx           选项 (动画反馈)
│       ├── QuizFeedback.tsx         对错反馈
│       ├── AbilityCurve.tsx         能力曲线 (recharts)
│       ├── QuizComplete.tsx         完成画面 (SVG 环形动画)
│       └── QuizTimer.tsx            计时器
│
├── [id]/report/
│   ├── page.tsx                     报告页入口
│   ├── ReportContent.tsx            报告布局
│   └── components/
│       ├── ScoreOverview.tsx         分数环 (SVG 动画)
│       ├── GapAnalysis.tsx           差距柱状图 (recharts)
│       ├── KnowledgeHeatmap.tsx      知识点热力图 (CSS Grid)
│       ├── TimelineProjection.tsx    进步预测 (recharts Area)
│       ├── LearningPath.tsx          学习路径 (时间线)
│       ├── ServiceRecommendations.tsx 服务推荐 CTA
│       ├── ReportActions.tsx         分享/PDF/重测按钮
│       ├── PdfExportButton.tsx       PDF 导出 (html2canvas + jsPDF)
│       └── ReportGenerating.tsx      等待页 (旋转提示)
│
├── shared/[token]/page.tsx          公开分享报告
│
├── hooks/
│   ├── useAnonymousId.ts            localStorage UUID 管理
│   ├── useQuiz.ts                   答题状态 + API 调用
│   └── useReport.ts                 报告轮询
│
└── types/
    └── assessment.ts                TypeScript 接口定义
```

---

## 9. Docker 部署

无需新增任何 Docker 服务，完全复用现有 6 服务架构：

| 服务 | 角色 | 端口 |
|------|------|------|
| basis-postgres | 数据库 | 5433 |
| basis-redis | 缓存 | 6379 |
| basis-qdrant | 向量存储 (Mem0) | 6333 |
| basis-api | Business API (FastAPI) | 5096 |
| basis-agent | LangGraph Agent | 5095 |
| basis-frontend | Next.js | 8015 |

**题库初始化**: API 启动时自动调用 `seed_question_bank()`，检测到题库为空时插入种子题。

---

## 10. 关键文件索引

| 文件 | 功能 |
|------|------|
| `src/basis_expert_council/assessment_engine.py` | CAT 引擎 (start/submit/complete) |
| `src/basis_expert_council/seed_questions_math.py` | 数学种子题库 (G5-G8, 100 道) |
| `src/basis_expert_council/db.py` | DB CRUD (schema + 17 函数) |
| `src/basis_expert_council/server.py` | API 路由 (12 个测评端点) |
| `src/basis_expert_council/assessment/report.py` | 报告生成 (规则 + Agent) |
| `src/basis_expert_council/assessment/scoring.py` | 统计计算 |
| `src/basis_expert_council/assessment/models.py` | Pydantic 模型 |
| `src/basis_expert_council/assessment/engine.py` | 模块化 CAT (备选) |
| `src/basis_expert_council/assessment/seed_questions.py` | 英文种子题 (备选) |

---

## 11. 扩展路线图

### Phase 2: 题库专业化
- [ ] 导入 BASIS 真题 (各年级各学科)
- [ ] 题目难度标定 (IRT 模型)
- [ ] 题目标签体系对齐 BASIS 课标
- [ ] 支持 fill_in 和主观题评分

### Phase 3: 智能化
- [ ] AI Agent 实时分析 (不再依赖异步)
- [ ] Mem0 记录学生长期学习轨迹
- [ ] 个性化学习路径推荐
- [ ] 与家长端/教师端联动

### Phase 4: 规模化
- [ ] A/B 测试不同出题策略
- [ ] 题目曝光率均衡
- [ ] 防作弊机制 (时间异常检测, IP 限制)
- [ ] 多语言真题 (对应不同 BASIS 校区)

---

## 12. E2E 验证记录

```
测试日期: 2026-02-21
环境: Docker Compose (local)

Test 1 — Subject Diagnostic (G6 Math, 15题):
  状态: PASS
  结果: 15/15 题顺利出完
  得分: 33, 能力: 0.33, 等效: Below G6

Test 2 — Pre-Admission (G7 Math, 20题):
  状态: PASS
  结果: 25 题出完 (CAT fallback 到相邻年级)
  得分: 47, 能力: 0.47, 等效: Approaching G7

报告状态: 立即 "ready" (规则计算即时完成)
分享链接: 功能正常
断点续做: 通过 /resume 端点支持
```
