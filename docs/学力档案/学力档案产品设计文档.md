# 学力档案 (Academic Profile) — 产品设计文档

> 版本: v1.0 | 日期: 2026-02-21 | 路由: `/profile/academic`

---

## 1. 产品定位

BasisPilot 目前只有**单次测评报告页**（`/assessment/[id]/report`），是快照视图。学力档案是一个**纵向聚合**面板，将所有历史测评数据集合在一起，提供：

- 学科能力雷达图（多学科横向对比）
- 知识点掌握度进度条（细粒度诊断）
- 能力趋势折线图（纵向时间变化）
- 测评历史时间线（快速回溯）

**目标用户**: 学生本人、家长（可切换查看子女数据）

---

## 2. 信息架构

```
/profile/academic
├─ 顶部导航栏（返回 Chat + 页面标题）
├─ [家长角色] 学生切换器 <Select>
├─ AcademicHeader（头像环 + 综合分 + 能力等级 badge）
├─ KpiCards（4 个指标卡：测评总数 / 平均分 / 进步幅度 / 答题总数）
└─ Tabs
    ├─ 总览 (overview)
    │   ├─ SubjectRadar — 双层多边形雷达图（我的 vs 平均）
    │   └─ AbilityTrend — Recharts 多线折线图（学科筛选）
    ├─ 学科详情 (subjects)
    │   └─ TopicProgress — 可折叠学科 > 知识点进度条
    └─ 测评历史 (history)
        └─ AssessmentTimeline — 竖线时间线（科目+分数+等级+查看报告）
```

**空状态**: 无测评记录时显示引导页 → `/assessment`

---

## 3. 数据模型

### 3.1 `student_ability_scores` — 能力快照表

每个 user × subject × topic 一行，UPSERT 滚动加权平均。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | SERIAL PK | 自增主键 |
| user_id | INT FK → biz_users | 用户 ID |
| subject | TEXT | 学科 (math/english/physics/...) |
| topic | TEXT NULL | 知识点名，NULL = 学科总分 |
| ability_score | REAL | 能力值 0.0-1.0 |
| score_100 | REAL | 百分制 0-100 (derived) |
| confidence | REAL | 置信度 0.0-1.0，随测评次数递增 |
| assessment_count | INT | 该维度累计测评次数 |
| last_session_id | UUID | 最近一次测评会话 |
| updated_at | TIMESTAMPTZ | 最近更新时间 |

**唯一约束**: `UNIQUE(user_id, subject, topic)`

**滚动加权平均算法**:
```
new_score = (old_score * count + new_score) / (count + 1)
confidence = min(1.0, 0.5 + count * 0.1)
```

### 3.2 `ability_score_history` — 时间序列表

Append-only，每次测评追加一条记录，用于趋势图。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | SERIAL PK | 自增主键 |
| user_id | INT FK → biz_users | 用户 ID |
| subject | TEXT | 学科 |
| topic | TEXT NULL | 知识点名 |
| ability_score | REAL | 能力值 0.0-1.0 |
| score_100 | REAL | 百分制 |
| session_id | UUID FK → assessment_sessions | 来源会话 |
| recorded_at | TIMESTAMPTZ | 记录时间 |

---

## 4. 后端 API

### `GET /api/academic/profile`

**认证**: 需登录（BASIS JWT）

**查询参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| student_id | INT (可选) | 家长查看子女数据时传入 |

**响应 JSON 结构**:
```json
{
  "student": {
    "id": 1,
    "nickname": "小明",
    "grade": "G7",
    "school_name": "BASIS Shenzhen",
    "campus": "shenzhen",
    "ap_courses": null
  },
  "subjects": [
    {
      "subject": "math",
      "ability_score": 0.72,
      "score_100": 72.0,
      "confidence": 0.8,
      "assessment_count": 3,
      "topics": [
        { "topic": "Algebra", "ability_score": 0.85, "score_100": 85.0 },
        { "topic": "Geometry", "ability_score": 0.60, "score_100": 60.0 }
      ]
    }
  ],
  "history": [
    {
      "subject": "math",
      "topic": null,
      "score_100": 65.0,
      "recorded_at": "2026-01-15T10:30:00+00:00"
    }
  ],
  "recent_sessions": [
    {
      "id": "uuid",
      "subject": "math",
      "final_score": 72.0,
      "ability_level": 0.72,
      "assessment_type": "subject_diagnostic",
      "completed_at": "2026-02-20T14:00:00+00:00"
    }
  ],
  "kpi": {
    "total_assessments": 5,
    "overall_accuracy": 71.2,
    "improvement_pct": 10.8,
    "total_questions": 75
  }
}
```

**家长权限**: 通过 `parent_student_links` 表验证是否有查看权限。

---

## 5. 数据写入流程

### 5.1 实时写入（新测评完成时）

```
assessment_engine.complete_session()
  ├─ compute_session_stats()
  ├─ update_assessment_session(status="completed")
  ├─ create_assessment_report()
  └─ [NEW] 学力档案记录
      ├─ upsert_ability_score(subject, topic=None, score)  # 学科总分
      ├─ insert_ability_history(subject, topic=None, score) # 时间序列
      └─ for each topic_score:
          ├─ upsert_ability_score(subject, topic, accuracy)
          └─ insert_ability_history(subject, topic, accuracy)
```

### 5.2 回填（匿名用户注册后）

`backfill_ability_scores_for_user(user_id)` 遍历该用户已完成的所有 session + report_data，按时间顺序补写能力分数。

---

## 6. 前端组件架构

### 6.1 共享组件（从 report 页提取复用）

| 组件 | 路径 | Props |
|------|------|-------|
| `ScoreRing` | `components/ScoreRing.tsx` | score, size?, color?, animated?, label? |
| `ProgressBar` | `components/ProgressBar.tsx` | label, value, showPercentage?, size? |

**ScoreRing**: 带 requestAnimationFrame count-up 动画的 SVG 圆环，支持自定义颜色和尺寸。

**ProgressBar**: 语义化颜色编码：
- 绿色 ≥70% → 黄色 50-70% → 橙色 30-50% → 红色 <30%

### 6.2 页面子组件

| 组件 | 说明 |
|------|------|
| `AcademicHeader` | 学生信息 + ScoreRing 综合分 + 能力等级 badge (A+/A/B+/B/C+/C) |
| `KpiCards` | 2×2 / 4 col 网格，Lucide icons (BarChart3/CheckCircle/TrendingUp/Target) |
| `SubjectRadar` | 自研 SVG 雷达图，双层多边形（teal=我的, gray-dashed=年级平均 60 占位），<3 学科 fallback 为柱状 |
| `TopicProgress` | 按学科可折叠面板，每个 topic 一个 ProgressBar |
| `AbilityTrend` | Recharts LineChart，多线(每科一色)，X=日期 Y=0-100，学科下拉筛选 |
| `AssessmentTimeline` | 竖线时间线，每条显示科目 badge + 分数 + 类型 + 日期 + "查看报告" 链接 |
| `EmptyState` | 空状态引导页，CTA 按钮跳转 `/assessment` |

### 6.3 学科颜色映射

```typescript
const SUBJECT_COLORS = {
  math:      "#14b8a6",  // teal
  english:   "#8b5cf6",  // violet
  physics:   "#f59e0b",  // amber
  chemistry: "#ef4444",  // red
  biology:   "#22c55e",  // green
  history:   "#3b82f6",  // blue
  science:   "#14b8a6",  // teal (same as math)
};
```

---

## 7. 入口链接 (3 处)

| 位置 | 样式 | 说明 |
|------|------|------|
| Chat 用户菜单 | BarChart3 icon + 文字链接 | Profile link 下方 |
| WelcomeScreen | 紫色 banner (区分 teal 测评 banner) | 测评 banner 下方 |
| 测评报告页底部 | 紫色 CTA 卡片 "查看完整学力档案 →" | ServiceRecommendations 与 Action buttons 之间 |

---

## 8. 路由保护

- `middleware.ts`: `/profile/*` 不在豁免列表 → 未登录重定向 `/`
- `KycGuard.tsx`: `/profile/*` 不在白名单 → 未完成 KYC 重定向 `/onboarding`
- 无需额外配置，已有保护机制自动覆盖

---

## 9. i18n

共 40+ 翻译键，覆盖 3 语言：
- `zh-CN` (简体中文)
- `en` (English)
- `zh-TW` (繁體中文)

分类: 页面标题 / KPI×4 / Tab×3 / 雷达图 / 进度条 / 趋势图 / 时间线 / 空状态 / 家长切换器 / 菜单入口 / WelcomeScreen banner / Report CTA / 学科名称×7 / 测评类型×3

翻译文件: `frontend/src/i18n/translations/academic.ts`

---

## 10. 文件清单

### 新建文件 (11)

| 文件 | 说明 |
|------|------|
| `frontend/src/app/components/ScoreRing.tsx` | 共享 SVG 分数环组件 |
| `frontend/src/app/components/ProgressBar.tsx` | 共享进度条组件 |
| `frontend/src/i18n/translations/academic.ts` | 学力档案 i18n 翻译 |
| `frontend/src/app/profile/academic/page.tsx` | 主页面 |
| `frontend/src/app/profile/academic/components/AcademicHeader.tsx` | 页头组件 |
| `frontend/src/app/profile/academic/components/KpiCards.tsx` | KPI 卡片组件 |
| `frontend/src/app/profile/academic/components/SubjectRadar.tsx` | 学科雷达图组件 |
| `frontend/src/app/profile/academic/components/TopicProgress.tsx` | 知识点进度组件 |
| `frontend/src/app/profile/academic/components/AbilityTrend.tsx` | 能力趋势图组件 |
| `frontend/src/app/profile/academic/components/AssessmentTimeline.tsx` | 测评时间线组件 |
| `frontend/src/app/profile/academic/components/EmptyState.tsx` | 空状态组件 |

### 修改文件 (8)

| 文件 | 变更 |
|------|------|
| `src/basis_expert_council/db.py` | +2 表 DDL + 6 CRUD 函数 + backfill |
| `deploy/init.sql` | +2 表 DDL |
| `src/basis_expert_council/assessment_engine.py` | complete_session() 能力分数写入 hook |
| `src/basis_expert_council/server.py` | +1 API endpoint |
| `frontend/src/app/assessment/[id]/report/page.tsx` | ScoreRing 提取 + Academic Profile CTA |
| `frontend/src/app/chat/page.tsx` | 菜单 +1 学力档案链接 |
| `frontend/src/app/components/WelcomeScreen.tsx` | +1 紫色 banner |
| `frontend/src/i18n/translations/index.ts` | 注册 academic 翻译 |

---

## 11. 设计系统一致性

- 深色背景: `bg-slate-950`
- 卡片: `border border-white/[0.06] bg-white/[0.03] rounded-2xl p-8`
- 品牌色: teal `#14b8a6` (主色调), purple (学力档案专属强调色)
- 图表: Recharts (折线图) + 自研 SVG (雷达图/分数环)
- 进度条语义色: 绿/黄/橙/红 四级
- 字体: `text-white` (标题), `text-slate-300` (正文), `text-slate-400/500` (辅助)
- 动画: `transition-all duration-1000 ease-out` (进度条/分数环)

---

## 12. 未来迭代方向

- [ ] 年级平均分数据源（当前雷达图 average 层为 60 分占位）
- [ ] 能力等级文案国际化（当前 A+/A/B+ 硬编码）
- [ ] 知识点掌握度的时间趋势（当前趋势图只展示学科级）
- [ ] 分享学力档案（生成分享链接/PDF 导出）
- [ ] 家长视图增强：多子女对比、学习建议推送
- [ ] 与 Mem0 记忆系统联动：自动生成个性化学习建议
